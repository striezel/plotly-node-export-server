const assert = require('node:assert');
const http = require('node:http');
const { describe, it } = require('node:test');

describe('basic charts, part 4', () => {
  describe('pie charts', () => {
    it('Basic Pie Chart', () => {
      const options = {
        port: 3000,
        host: 'localhost',
        method: 'POST'
      };

      const req = http.request(options);
      // Data taken from https://plotly.com/javascript/pie-charts/#basic-pie-chart example.
      const payload = `{
                         "data": [
                           {
                             "values": [ 19, 26, 55 ],
                             "labels": [ "Residential", "Non-Residential", "Utility" ],
                             "type": "pie"
                           }
                         ],
                         "layout": {
                           "height": 400,
                           "width": 500
                         }
                       }`;
      req.write(payload);
      req.end();

      req.on('response', (response) => {
        assert.strictEqual(200, response.statusCode);
        let body = '';
        response.on('data', (chunk) => {
          body += chunk;
        });
        response.on('end', () => {
          assert.ok(body.startsWith('<svg'));
          assert.ok(body.endsWith('</svg>'));

          // Browser-based answer would be something like
          // <svg class="main-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="500" height="400" style="" viewBox="0 0 500 400"><rect x="0" y="0" width="500" height="400" style="fill: rgb(255, 255, 255); fill-opacity: 1;"/><defs id="defs-ed958c"><g class="clips"/><g class="gradients"/><g class="patterns"/></defs><g class="bglayer"/><g class="layer-below"><g class="imagelayer"/><g class="shapelayer"/></g><g class="cartesianlayer"/><g class="polarlayer"/><g class="smithlayer"/><g class="ternarylayer"/><g class="geolayer"/><g class="funnelarealayer"/><g class="pielayer"><g class="trace" stroke-linejoin="round" style="opacity: 1;"><g class="slice"><path class="surface" style="pointer-events: none; fill: rgb(31, 119, 180); fill-opacity: 1; stroke-width: 0px; stroke: rgb(68, 68, 68); stroke-opacity: 1;" d="M215,210l0,-110a110,110 0 1 1 -33.99186938124425,214.6162167924669Z"/><g class="slicetext"><text data-notex="1" class="slicetext" transform="translate(269.3228587327326,222.6038955772127)" text-anchor="middle" style="font-family: TOBESTRIPPEDOpen SansTOBESTRIPPED, verdana, arial, sans-serif; font-size: 12px; fill: rgb(255, 255, 255); fill-opacity: 1; white-space: pre;" x="0" y="0">55%</text></g></g><g class="slice"><path class="surface" style="pointer-events: none; fill: rgb(255, 127, 14); fill-opacity: 1; stroke-width: 0px; stroke: rgb(68, 68, 68); stroke-opacity: 1;" d="M215,210l-109.78294012710987,6.906957148224474a110,110 0 0 1 109.78294012710987,-116.90695714822448Z"/><g class="slicetext"><text data-notex="1" class="slicetext" transform="translate(168.62174434827907,170.44791903225067)" text-anchor="middle" style="font-family: TOBESTRIPPEDOpen SansTOBESTRIPPED, verdana, arial, sans-serif; font-size: 12px; fill: rgb(68, 68, 68); fill-opacity: 1; white-space: pre;" x="0" y="0">26%</text></g></g><g class="slice"><path class="surface" style="pointer-events: none; fill: rgb(44, 160, 44); fill-opacity: 1; stroke-width: 0px; stroke: rgb(68, 68, 68); stroke-opacity: 1;" d="M215,210l-33.991869381244186,104.6162167924669a110,110 0 0 1 -75.79107074586568,-97.70925964424242Z"/><g class="slicetext"><text data-notex="1" class="slicetext" transform="translate(159.35825091434162,257.16016472470875)" text-anchor="middle" style="font-family: TOBESTRIPPEDOpen SansTOBESTRIPPED, verdana, arial, sans-serif; font-size: 12px; fill: rgb(255, 255, 255); fill-opacity: 1; white-space: pre;" x="0" y="0">19%</text></g></g></g></g><g class="iciclelayer"/><g class="treemaplayer"/><g class="sunburstlayer"/><g class="glimages"/><defs id="topdefs-ed958c"><g class="clips"/><clipPath id="legended958c"><rect width="133" height="67" x="0" y="0"/></clipPath></defs><g class="layer-above"><g class="imagelayer"/><g class="shapelayer"/></g><g class="infolayer"><g class="legend" pointer-events="all" transform="translate(355.4,100)"><rect class="bg" shape-rendering="crispEdges" style="stroke: rgb(68, 68, 68); stroke-opacity: 1; fill: rgb(255, 255, 255); fill-opacity: 1; stroke-width: 0px;" width="133" height="67" x="0" y="0"/><g class="scrollbox" transform="" clip-path="url(#legended958c)"><g class="groups"><g class="traces" style="opacity: 1;" transform="translate(0,14.5)"><text class="legendtext" text-anchor="start" style="font-family: TOBESTRIPPEDOpen SansTOBESTRIPPED, verdana, arial, sans-serif; font-size: 12px; fill: rgb(68, 68, 68); fill-opacity: 1; white-space: pre;" x="40" y="4.680000000000001">Utility</text><g class="layers" style="opacity: 1;"><g class="legendfill"/><g class="legendlines"/><g class="legendsymbols"><g class="legendpoints"><path class="legendpie" d="M6,6H-6V-6H6Z" transform="translate(20,0)" style="fill: rgb(31, 119, 180); fill-opacity: 1; stroke-width: 0px; stroke: rgb(68, 68, 68); stroke-opacity: 1;"/></g></g></g><rect class="legendtoggle" style="fill: rgb(0, 0, 0); fill-opacity: 0;" x="0" y="-9.5" width="127.35000610351562" height="19"/></g><g class="traces" style="opacity: 1;" transform="translate(0,33.5)"><text class="legendtext" text-anchor="start" style="font-family: TOBESTRIPPEDOpen SansTOBESTRIPPED, verdana, arial, sans-serif; font-size: 12px; fill: rgb(68, 68, 68); fill-opacity: 1; white-space: pre;" x="40" y="4.680000000000001">Non-Residential</text><g class="layers" style="opacity: 1;"><g class="legendfill"/><g class="legendlines"/><g class="legendsymbols"><g class="legendpoints"><path class="legendpie" d="M6,6H-6V-6H6Z" transform="translate(20,0)" style="fill: rgb(255, 127, 14); fill-opacity: 1; stroke-width: 0px; stroke: rgb(68, 68, 68); stroke-opacity: 1;"/></g></g></g><rect class="legendtoggle" style="fill: rgb(0, 0, 0); fill-opacity: 0;" x="0" y="-9.5" width="127.35000610351562" height="19"/></g><g class="traces" style="opacity: 1;" transform="translate(0,52.5)"><text class="legendtext" text-anchor="start" style="font-family: TOBESTRIPPEDOpen SansTOBESTRIPPED, verdana, arial, sans-serif; font-size: 12px; fill: rgb(68, 68, 68); fill-opacity: 1; white-space: pre;" x="40" y="4.680000000000001">Residential</text><g class="layers" style="opacity: 1;"><g class="legendfill"/><g class="legendlines"/><g class="legendsymbols"><g class="legendpoints"><path class="legendpie" d="M6,6H-6V-6H6Z" transform="translate(20,0)" style="fill: rgb(44, 160, 44); fill-opacity: 1; stroke-width: 0px; stroke: rgb(68, 68, 68); stroke-opacity: 1;"/></g></g></g><rect class="legendtoggle" style="fill: rgb(0, 0, 0); fill-opacity: 0;" x="0" y="-9.5" width="127.35000610351562" height="19"/></g></g></g><rect class="scrollbar" rx="20" ry="3" width="0" height="0" style="fill: rgb(128, 139, 164); fill-opacity: 1;" x="0" y="0"/></g><g class="g-gtitle"/></g></svg>

          // Current server response is something like
          // <svg class="main-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="500" height="400" style="" viewBox="0 0 500 400"><rect x="0" y="0" width="500" height="400" style="fill: rgb(255, 255, 255); fill-opacity: 1;"/><defs id="defs-96ac50"><g class="clips"/><g class="gradients"/><g class="patterns"/></defs><g class="bglayer"/><g class="layer-below"><g class="imagelayer"/><g class="shapelayer"/></g><g class="cartesianlayer"/><g class="polarlayer"/><g class="smithlayer"/><g class="ternarylayer"/><g class="geolayer"/><g class="funnelarealayer"/><g class="pielayer"><g class="trace" stroke-linejoin="round" style="opacity: 1;"><g class="slice"><path class="surface" style="pointer-events: none; fill: rgb(31, 119, 180); fill-opacity: 1; stroke-width: 0; stroke: rgb(68, 68, 68); stroke-opacity: 1;" d="M250,210l0,-110a110,110 0 1 1 -33.99186938124425,214.6162167924669Z"/><g class="slicetext"><text data-notex="1" class="slicetext" transform="translate(304.3228587327326,218.6038955772127)" text-anchor="middle" style="font-family: TOBESTRIPPEDOpen SansTOBESTRIPPED, verdana, arial, sans-serif; font-size: 12px; fill: rgb(255, 255, 255); fill-opacity: 1; white-space: pre;" x="0" y="0">55%</text></g></g><g class="slice"><path class="surface" style="pointer-events: none; fill: rgb(255, 127, 14); fill-opacity: 1; stroke-width: 0; stroke: rgb(68, 68, 68); stroke-opacity: 1;" d="M250,210l-109.78294012710987,6.906957148224474a110,110 0 0 1 109.78294012710987,-116.90695714822448Z"/><g class="slicetext"><text data-notex="1" class="slicetext" transform="translate(203.62174434827907,166.44791903225067)" text-anchor="middle" style="font-family: TOBESTRIPPEDOpen SansTOBESTRIPPED, verdana, arial, sans-serif; font-size: 12px; fill: rgb(68, 68, 68); fill-opacity: 1; white-space: pre;" x="0" y="0">26%</text></g></g><g class="slice"><path class="surface" style="pointer-events: none; fill: rgb(44, 160, 44); fill-opacity: 1; stroke-width: 0; stroke: rgb(68, 68, 68); stroke-opacity: 1;" d="M250,210l-33.991869381244186,104.6162167924669a110,110 0 0 1 -75.79107074586568,-97.70925964424242Z"/><g class="slicetext"><text data-notex="1" class="slicetext" transform="translate(194.35825091434162,253.16016472470875)" text-anchor="middle" style="font-family: TOBESTRIPPEDOpen SansTOBESTRIPPED, verdana, arial, sans-serif; font-size: 12px; fill: rgb(255, 255, 255); fill-opacity: 1; white-space: pre;" x="0" y="0">19%</text></g></g></g></g><g class="iciclelayer"/><g class="treemaplayer"/><g class="sunburstlayer"/><g class="glimages"/><defs id="topdefs-96ac50"><g class="clips"/><clipPath id="legend96ac50"><rect width="45" height="67" x="0" y="0"/></clipPath></defs><g class="layer-above"><g class="imagelayer"/><g class="shapelayer"/></g><g class="infolayer"><g class="legend" pointer-events="all" transform="translate(426.8,100)"><rect class="bg" shape-rendering="crispEdges" style="stroke: rgb(68, 68, 68); stroke-opacity: 1; fill: rgb(255, 255, 255); fill-opacity: 1; stroke-width: 0px;" width="45" height="67" x="0" y="0"/><g class="scrollbox" transform="" clip-path="url(#legend96ac50)"><g class="groups"><g class="traces" style="opacity: 1;" transform="translate(0,14.5)"><text class="legendtext" text-anchor="start" style="font-family: TOBESTRIPPEDOpen SansTOBESTRIPPED, verdana, arial, sans-serif; font-size: 12px; fill: rgb(68, 68, 68); fill-opacity: 1; white-space: pre;" x="40" y="4.680000000000001">Utility</text><g class="layers" style="opacity: 1;"><g class="legendfill"/><g class="legendlines"/><g class="legendsymbols"><g class="legendpoints"><path class="legendpie" d="M6,6H-6V-6H6Z" transform="translate(20,0)" style="fill: rgb(31, 119, 180); fill-opacity: 1; stroke-width: 0; stroke: rgb(68, 68, 68); stroke-opacity: 1;"/></g></g></g><rect class="legendtoggle" style="fill: rgb(0, 0, 0); fill-opacity: 0;" x="0" y="-9.5" width="40" height="19"/></g><g class="traces" style="opacity: 1;" transform="translate(0,33.5)"><text class="legendtext" text-anchor="start" style="font-family: TOBESTRIPPEDOpen SansTOBESTRIPPED, verdana, arial, sans-serif; font-size: 12px; fill: rgb(68, 68, 68); fill-opacity: 1; white-space: pre;" x="40" y="4.680000000000001">Non-Residential</text><g class="layers" style="opacity: 1;"><g class="legendfill"/><g class="legendlines"/><g class="legendsymbols"><g class="legendpoints"><path class="legendpie" d="M6,6H-6V-6H6Z" transform="translate(20,0)" style="fill: rgb(255, 127, 14); fill-opacity: 1; stroke-width: 0; stroke: rgb(68, 68, 68); stroke-opacity: 1;"/></g></g></g><rect class="legendtoggle" style="fill: rgb(0, 0, 0); fill-opacity: 0;" x="0" y="-9.5" width="40" height="19"/></g><g class="traces" style="opacity: 1;" transform="translate(0,52.5)"><text class="legendtext" text-anchor="start" style="font-family: TOBESTRIPPEDOpen SansTOBESTRIPPED, verdana, arial, sans-serif; font-size: 12px; fill: rgb(68, 68, 68); fill-opacity: 1; white-space: pre;" x="40" y="4.680000000000001">Residential</text><g class="layers" style="opacity: 1;"><g class="legendfill"/><g class="legendlines"/><g class="legendsymbols"><g class="legendpoints"><path class="legendpie" d="M6,6H-6V-6H6Z" transform="translate(20,0)" style="fill: rgb(44, 160, 44); fill-opacity: 1; stroke-width: 0; stroke: rgb(68, 68, 68); stroke-opacity: 1;"/></g></g></g><rect class="legendtoggle" style="fill: rgb(0, 0, 0); fill-opacity: 0;" x="0" y="-9.5" width="40" height="19"/></g></g></g><rect class="scrollbar" rx="20" ry="3" width="0" height="0" style="fill: rgb(128, 139, 164); fill-opacity: 1;" x="0" y="0"/></g><g class="g-gtitle"/></g></svg>

          // Check partial matches, avoiding the random id bits.
          assert.ok(body.indexOf('<svg class="main-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="500" height="400" style="" viewBox="0 0 500 400"><rect x="0" y="0" width="500" height="400" style="fill: rgb(255, 255, 255); fill-opacity: 1;"/><defs id="defs') >= 0);
          assert.ok(body.indexOf('<g class="clips"/><g class="gradients"/><g class="patterns"/></defs><g class="bglayer"/><g class="layer-below"><g class="imagelayer"/><g class="shapelayer"/></g><g class="cartesianlayer"/><g class="polarlayer"/><g class="smithlayer"/><g class="ternarylayer"/><g class="geolayer"/><g class="funnelarealayer"/><g class="pielayer"><g class="trace" stroke-linejoin="round" style="opacity: 1;"><g class="slice"><path class="surface" style="pointer-events: none; fill: rgb(31, 119, 180); fill-opacity: 1; stroke-width: 0; stroke: rgb(68, 68, 68); stroke-opacity: 1;" d="M250,210l0,-110a110,110 0 1 1 -33.99186938124425,214.6162167924669Z"/><g class="slicetext"><text data-notex="1" class="slicetext" transform="translate(304.3228587327326,218.6038955772127)" text-anchor="middle" style="font-family: TOBESTRIPPEDOpen SansTOBESTRIPPED, verdana, arial, sans-serif; font-size: 12px; fill: rgb(255, 255, 255); fill-opacity: 1; white-space: pre;" x="0" y="0">55%</text></g></g><g class="slice"><path class="surface" style="pointer-events: none; fill: rgb(255, 127, 14); fill-opacity: 1; stroke-width: 0; stroke: rgb(68, 68, 68); stroke-opacity: 1;" d="M250,210l-109.78294012710987,6.906957148224474a110,110 0 0 1 109.78294012710987,-116.90695714822448Z"/><g class="slicetext"><text data-notex="1" class="slicetext" transform="translate(203.62174434827907,166.44791903225067)" text-anchor="middle" style="font-family: TOBESTRIPPEDOpen SansTOBESTRIPPED, verdana, arial, sans-serif; font-size: 12px; fill: rgb(68, 68, 68); fill-opacity: 1; white-space: pre;" x="0" y="0">26%</text></g></g><g class="slice"><path class="surface" style="pointer-events: none; fill: rgb(44, 160, 44); fill-opacity: 1; stroke-width: 0; stroke: rgb(68, 68, 68); stroke-opacity: 1;" d="M250,210l-33.991869381244186,104.6162167924669a110,110 0 0 1 -75.79107074586568,-97.70925964424242Z"/><g class="slicetext"><text data-notex="1" class="slicetext" transform="translate(194.35825091434162,253.16016472470875)" text-anchor="middle" style="font-family: TOBESTRIPPEDOpen SansTOBESTRIPPED, verdana, arial, sans-serif; font-size: 12px; fill: rgb(255, 255, 255); fill-opacity: 1; white-space: pre;" x="0" y="0">19%</text></g></g></g></g><g class="iciclelayer"/><g class="treemaplayer"/><g class="sunburstlayer"/><g class="glimages"/><defs id="topdefs-') > 0);
          assert.ok(body.indexOf('"><g class="clips"/><clipPath id="legend') > 0);
          assert.ok(body.indexOf('<rect width="45" height="67" x="0" y="0"/></clipPath></defs><g class="layer-above"><g class="imagelayer"/><g class="shapelayer"/></g><g class="infolayer"><g class="legend" pointer-events="all" transform="translate(426.8,100)"><rect class="bg" shape-rendering="crispEdges" style="stroke: rgb(68, 68, 68); stroke-opacity: 1; fill: rgb(255, 255, 255); fill-opacity: 1; stroke-width: 0px;" width="45" height="67" x="0" y="0"/><g class="scrollbox" transform="" clip-path="url(#legend') > 0);
          assert.ok(body.indexOf('<g class="groups"><g class="traces" style="opacity: 1;" transform="translate(0,14.5)"><text class="legendtext" text-anchor="start" style="font-family: TOBESTRIPPEDOpen SansTOBESTRIPPED, verdana, arial, sans-serif; font-size: 12px; fill: rgb(68, 68, 68); fill-opacity: 1; white-space: pre;" x="40" y="4.680000000000001">Utility</text><g class="layers" style="opacity: 1;"><g class="legendfill"/><g class="legendlines"/><g class="legendsymbols"><g class="legendpoints"><path class="legendpie" d="M6,6H-6V-6H6Z" transform="translate(20,0)" style="fill: rgb(31, 119, 180); fill-opacity: 1; stroke-width: 0; stroke: rgb(68, 68, 68); stroke-opacity: 1;"/></g></g></g><rect class="legendtoggle" style="fill: rgb(0, 0, 0); fill-opacity: 0;" x="0" y="-9.5" width="40" height="19"/></g><g class="traces" style="opacity: 1;" transform="translate(0,33.5)"><text class="legendtext" text-anchor="start" style="font-family: TOBESTRIPPEDOpen SansTOBESTRIPPED, verdana, arial, sans-serif; font-size: 12px; fill: rgb(68, 68, 68); fill-opacity: 1; white-space: pre;" x="40" y="4.680000000000001">Non-Residential</text><g class="layers" style="opacity: 1;"><g class="legendfill"/><g class="legendlines"/><g class="legendsymbols"><g class="legendpoints"><path class="legendpie" d="M6,6H-6V-6H6Z" transform="translate(20,0)" style="fill: rgb(255, 127, 14); fill-opacity: 1; stroke-width: 0; stroke: rgb(68, 68, 68); stroke-opacity: 1;"/></g></g></g><rect class="legendtoggle" style="fill: rgb(0, 0, 0); fill-opacity: 0;" x="0" y="-9.5" width="40" height="19"/></g><g class="traces" style="opacity: 1;" transform="translate(0,52.5)"><text class="legendtext" text-anchor="start" style="font-family: TOBESTRIPPEDOpen SansTOBESTRIPPED, verdana, arial, sans-serif; font-size: 12px; fill: rgb(68, 68, 68); fill-opacity: 1; white-space: pre;" x="40" y="4.680000000000001">Residential</text><g class="layers" style="opacity: 1;"><g class="legendfill"/><g class="legendlines"/><g class="legendsymbols"><g class="legendpoints"><path class="legendpie" d="M6,6H-6V-6H6Z" transform="translate(20,0)" style="fill: rgb(44, 160, 44); fill-opacity: 1; stroke-width: 0; stroke: rgb(68, 68, 68); stroke-opacity: 1;"/></g></g></g><rect class="legendtoggle" style="fill: rgb(0, 0, 0); fill-opacity: 0;" x="0" y="-9.5" width="40" height="19"/></g></g></g><rect class="scrollbar" rx="20" ry="3" width="0" height="0" style="fill: rgb(128, 139, 164); fill-opacity: 1;" x="0" y="0"/></g><g class="g-gtitle"/></g></svg>') > 0);
        });
      });
    });

    // TODO: Pie Chart Subplots - https://plotly.com/javascript/pie-charts/#pie-chart-subplots
    // TODO: Donut Chart - https://plotly.com/javascript/pie-charts/#donut-chart
    // TODO: Automatically Adjust Margins - https://plotly.com/javascript/pie-charts/#automatically-adjust-margins
    // TODO: Control Text Orientation Inside Pie Chart Sectors - https://plotly.com/javascript/pie-charts/#control-text-orientation-inside-pie-chart-sectors

/*
    it('request with different data', () => {
      const options = {
        port: 3000,
        host: 'localhost',
        method: 'POST'
      };

      const req = http.request(options);
      const payload = '{ "x": ["2013-10-04 22:23:00", "2013-11-04 22:23:00", "2013-12-04 22:23:00"], "y": [1, 3, 6], "type": "scatter" }';
      req.write(payload);
      req.end();

      req.on('response', (response) => {
        assert.strictEqual(200, response.statusCode);
        let body = '';
        response.on('data', (chunk) => {
          body += chunk;
        });
        response.on('end', () => {
          assert.ok(body.startsWith('<svg'));
          assert.ok(body.endsWith('</svg>'));
          assert.ok(body.indexOf('width="700"') > 0);
          assert.ok(body.indexOf('height="400"') > 0);
        });
      });
    });
    */
  });
});
